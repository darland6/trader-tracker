{% extends "base.html" %}

{% block title %}Dashboard - Portfolio Manager{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Market Status Banner -->
    <div class="alert {% if market_open %}alert-success{% else %}alert-warning{% endif %} shadow-lg">
        <div>
            <span class="font-semibold">Market Status:</span>
            {% if market_session == 'regular' %}
                <span class="badge badge-success">Regular Hours</span>
            {% elif market_session == 'pre' %}
                <span class="badge badge-warning">Pre-Market</span>
            {% elif market_session == 'post' %}
                <span class="badge badge-warning">After-Hours</span>
            {% else %}
                <span class="badge badge-ghost">Closed</span>
            {% endif %}
            <span class="text-sm opacity-70 ml-2">
                {% if market_session == 'pre' %}(4:00 AM - 9:30 AM ET)
                {% elif market_session == 'regular' %}(9:30 AM - 4:00 PM ET)
                {% elif market_session == 'post' %}(4:00 PM - 8:00 PM ET)
                {% endif %}
            </span>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <!-- Total Value -->
        <div class="stat bg-base-100 rounded-lg shadow">
            <div class="stat-title">Total Value</div>
            <div class="stat-value text-primary">${{ "{:,.0f}".format(state.total_value) }}</div>
            <div class="stat-desc">Portfolio + Cash</div>
        </div>

        <!-- Cash -->
        <div class="stat bg-base-100 rounded-lg shadow">
            <div class="stat-title">Cash</div>
            <div class="stat-value text-secondary">${{ "{:,.0f}".format(state.cash) }}</div>
            <div class="stat-desc">Available for trading</div>
        </div>

        <!-- Portfolio Value -->
        <div class="stat bg-base-100 rounded-lg shadow">
            <div class="stat-title">Holdings Value</div>
            <div class="stat-value">${{ "{:,.0f}".format(state.portfolio_value) }}</div>
            <div class="stat-desc">{{ state.holdings|length }} positions</div>
        </div>

        <!-- YTD Income -->
        <div class="stat bg-base-100 rounded-lg shadow">
            <div class="stat-title">YTD Income</div>
            <div class="stat-value text-success">${{ "{:,.0f}".format(state.income.total) }}</div>
            <div class="stat-desc">{{ "{:.0f}".format(state.income.progress_pct) }}% of $30K goal</div>
            <progress class="progress progress-success w-full" value="{{ state.income.progress_pct }}" max="100"></progress>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Holdings Table -->
        <div class="lg:col-span-2">
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title">Holdings</h2>
                    <div class="overflow-x-auto">
                        <table class="table table-zebra">
                            <thead>
                                <tr>
                                    <th>Ticker</th>
                                    <th class="text-right">Shares</th>
                                    <th class="text-right">Price</th>
                                    <th class="text-right">Value</th>
                                    <th class="text-right">Gain/Loss</th>
                                    <th class="text-right">%</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for h in state.holdings %}
                                <tr>
                                    <td class="font-bold">{{ h.ticker }}</td>
                                    <td class="text-right">{{ "{:,}".format(h.shares) }}</td>
                                    <td class="text-right">
                                        ${{ "{:.2f}".format(h.current_price) }}
                                        {% if h.price_session == 'pre' %}
                                            <span class="badge badge-xs badge-warning ml-1" title="Pre-Market">PRE</span>
                                        {% elif h.price_session == 'post' %}
                                            <span class="badge badge-xs badge-warning ml-1" title="After-Hours">AH</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-right">${{ "{:,.0f}".format(h.market_value) }}</td>
                                    <td class="text-right {% if h.unrealized_gain >= 0 %}gain-positive{% else %}gain-negative{% endif %}">
                                        ${{ "{:,.0f}".format(h.unrealized_gain) }}
                                        <span class="text-xs">({{ "{:+.1f}".format(h.unrealized_gain_pct) }}%)</span>
                                    </td>
                                    <td class="text-right">{{ "{:.1f}".format(h.allocation_pct) }}%</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Active Options + Income Breakdown -->
        <div class="space-y-6">
            <!-- Active Options -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title">Active Options</h2>
                    {% if state.active_options %}
                    <div class="space-y-2">
                        {% for opt in state.active_options %}
                        <div class="flex justify-between items-center p-3 bg-base-200 rounded-lg">
                            <div>
                                <div class="font-bold">{{ opt.ticker }} ${{ opt.strike }}</div>
                                <div class="text-sm opacity-70">{{ opt.strategy }} exp {{ opt.expiration }}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-success">${{ "{:,.0f}".format(opt.premium) }}</div>
                                <div class="text-xs {% if opt.days_to_expiry <= 7 %}text-warning{% endif %}">
                                    {{ opt.days_to_expiry }} days
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-base-content/60">No active options</p>
                    {% endif %}
                </div>
            </div>

            <!-- Income Breakdown (Expandable) -->
            <div class="card bg-base-100 shadow-xl" x-data="incomeBreakdown()">
                <div class="card-body">
                    <h2 class="card-title">
                        Income Breakdown
                        <span class="text-sm font-normal opacity-60" x-text="year ? `(${year})` : ''"></span>
                    </h2>
                    <div class="space-y-1">
                        <!-- Trading Gains Row -->
                        <div class="collapse collapse-arrow bg-base-200 rounded-lg">
                            <input type="checkbox" @change="expanded.trades && loadDetails()" x-model="expanded.trades">
                            <div class="collapse-title py-2 min-h-0 flex justify-between items-center">
                                <span>Trading Gains</span>
                                <span class="font-mono">${{ "{:,.0f}".format(state.income.trading_gains) }}</span>
                            </div>
                            <div class="collapse-content">
                                <template x-if="loading">
                                    <div class="text-center py-2"><span class="loading loading-spinner loading-sm"></span></div>
                                </template>
                                <template x-if="!loading && details.trades">
                                    <div class="space-y-1 text-sm">
                                        <div class="flex justify-between opacity-60 text-xs mb-2">
                                            <span>Gains: <span class="text-success">$<span x-text="details.trades.gains?.toLocaleString()"></span></span></span>
                                            <span>Losses: <span class="text-error">-$<span x-text="details.trades.losses?.toLocaleString()"></span></span></span>
                                        </div>
                                        <template x-for="tx in details.trades.transactions" :key="tx.date + tx.ticker">
                                            <div class="flex justify-between items-center p-2 bg-base-300 rounded">
                                                <div>
                                                    <span class="font-bold" x-text="tx.ticker"></span>
                                                    <span class="text-xs opacity-60 ml-2" x-text="tx.date"></span>
                                                </div>
                                                <span class="font-mono" :class="tx.gain >= 0 ? 'text-success' : 'text-error'"
                                                      x-text="'$' + tx.gain?.toLocaleString()"></span>
                                            </div>
                                        </template>
                                        <template x-if="details.trades.transactions?.length === 0">
                                            <div class="text-center opacity-60 py-2">No trading gains this year</div>
                                        </template>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- Option Income Row -->
                        <div class="collapse collapse-arrow bg-base-200 rounded-lg">
                            <input type="checkbox" @change="expanded.options && loadDetails()" x-model="expanded.options">
                            <div class="collapse-title py-2 min-h-0 flex justify-between items-center">
                                <span>Option Income</span>
                                <span class="font-mono">${{ "{:,.0f}".format(state.income.option_income) }}</span>
                            </div>
                            <div class="collapse-content">
                                <template x-if="loading">
                                    <div class="text-center py-2"><span class="loading loading-spinner loading-sm"></span></div>
                                </template>
                                <template x-if="!loading && details.options">
                                    <div class="space-y-1 text-sm">
                                        <template x-for="tx in details.options.transactions" :key="tx.date + tx.ticker">
                                            <div class="flex justify-between items-center p-2 bg-base-300 rounded">
                                                <div>
                                                    <span class="font-bold" x-text="tx.ticker"></span>
                                                    <span class="text-xs ml-1" x-text="tx.strategy"></span>
                                                    <span class="text-xs opacity-60 ml-2" x-text="tx.date"></span>
                                                </div>
                                                <span class="font-mono text-success" x-text="'$' + tx.gain?.toLocaleString()"></span>
                                            </div>
                                        </template>
                                        <template x-if="details.options.transactions?.length === 0">
                                            <div class="text-center opacity-60 py-2">No option income this year</div>
                                        </template>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- Dividends Row -->
                        <div class="collapse collapse-arrow bg-base-200 rounded-lg">
                            <input type="checkbox" @change="expanded.dividends && loadDetails()" x-model="expanded.dividends">
                            <div class="collapse-title py-2 min-h-0 flex justify-between items-center">
                                <span>Dividends</span>
                                <span class="font-mono">${{ "{:,.0f}".format(state.income.dividends) }}</span>
                            </div>
                            <div class="collapse-content">
                                <template x-if="loading">
                                    <div class="text-center py-2"><span class="loading loading-spinner loading-sm"></span></div>
                                </template>
                                <template x-if="!loading && details.dividends">
                                    <div class="space-y-1 text-sm">
                                        <template x-for="tx in details.dividends.transactions" :key="tx.date + tx.ticker">
                                            <div class="flex justify-between items-center p-2 bg-base-300 rounded">
                                                <div>
                                                    <span class="font-bold" x-text="tx.ticker"></span>
                                                    <span class="text-xs opacity-60 ml-2" x-text="tx.date"></span>
                                                </div>
                                                <span class="font-mono text-success" x-text="'$' + tx.amount?.toLocaleString()"></span>
                                            </div>
                                        </template>
                                        <template x-if="details.dividends.transactions?.length === 0">
                                            <div class="text-center opacity-60 py-2">No dividends this year</div>
                                        </template>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <div class="divider my-1"></div>
                        <div class="flex justify-between font-bold">
                            <span>Total YTD</span>
                            <span class="font-mono text-success">${{ "{:,.0f}".format(state.income.total) }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <script>
                function incomeBreakdown() {
                    return {
                        expanded: { trades: false, options: false, dividends: false },
                        loading: false,
                        details: {},
                        year: null,
                        loaded: false,

                        async loadDetails() {
                            if (this.loaded) return;
                            this.loading = true;
                            try {
                                const response = await fetch('/api/income-breakdown');
                                const data = await response.json();
                                this.details = data;
                                this.year = data.year;
                                this.loaded = true;
                            } catch (error) {
                                console.error('Failed to load income details:', error);
                            }
                            this.loading = false;
                        }
                    }
                }
            </script>

            <!-- Gains Summary -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title">Gains Summary</h2>

                    <!-- Realized Gains -->
                    <div class="mb-3">
                        <h3 class="font-semibold text-sm opacity-70 mb-1">Realized (YTD Closed Positions)</h3>
                        <div class="space-y-1">
                            <div class="flex justify-between text-sm">
                                <span class="text-success">Gains</span>
                                <span class="font-mono text-success">${{ "{:,.0f}".format(state.gains.realized_gains) }}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-error">Losses</span>
                                <span class="font-mono text-error">-${{ "{:,.0f}".format(state.gains.realized_losses) }}</span>
                            </div>
                            <div class="flex justify-between font-semibold">
                                <span>Net Realized</span>
                                <span class="font-mono {% if state.gains.realized_net >= 0 %}text-success{% else %}text-error{% endif %}">
                                    ${{ "{:,.0f}".format(state.gains.realized_net) }}
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="divider my-1"></div>

                    <!-- Unrealized Gains -->
                    <div>
                        <h3 class="font-semibold text-sm opacity-70 mb-1">Unrealized (Open Positions)</h3>
                        <div class="space-y-1">
                            <div class="flex justify-between text-sm">
                                <span class="text-success">Gains</span>
                                <span class="font-mono text-success">${{ "{:,.0f}".format(state.gains.unrealized_gains) }}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-error">Losses</span>
                                <span class="font-mono text-error">-${{ "{:,.0f}".format(state.gains.unrealized_losses) }}</span>
                            </div>
                            <div class="flex justify-between font-semibold">
                                <span>Net Unrealized</span>
                                <span class="font-mono {% if state.gains.unrealized_net >= 0 %}text-success{% else %}text-error{% endif %}">
                                    ${{ "{:,.0f}".format(state.gains.unrealized_net) }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h2 class="card-title">Quick Actions</h2>
            <div class="flex flex-wrap gap-2">
                <a href="/trade" class="btn btn-primary">New Trade</a>
                <a href="/options" class="btn btn-secondary">Manage Options</a>
                <a href="/cash" class="btn btn-accent">Cash Transaction</a>
                <a href="/events" class="btn btn-ghost">View History</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}
