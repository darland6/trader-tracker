{% extends "base.html" %}

{% block title %}Event History - Portfolio Manager{% endblock %}

{% block content %}
<div class="card bg-base-100 shadow-xl">
    <div class="card-body">
        <div class="flex justify-between items-center mb-4">
            <h2 class="card-title text-2xl">Event History</h2>

            <!-- Filters -->
            <div class="flex gap-2">
                <select id="event-type-filter"
                        name="event_type"
                        class="select select-bordered select-sm"
                        hx-get="/events"
                        hx-target="#events-table"
                        hx-swap="outerHTML">
                    <option value="" {% if not selected_type %}selected{% endif %}>All Types</option>
                    <option value="TRADE" {% if selected_type == 'TRADE' %}selected{% endif %}>Trades</option>
                    <option value="OPTION_OPEN" {% if selected_type == 'OPTION_OPEN' %}selected{% endif %}>Options Opened</option>
                    <option value="OPTION_CLOSE" {% if selected_type == 'OPTION_CLOSE' %}selected{% endif %}>Options Closed</option>
                    <option value="DEPOSIT" {% if selected_type == 'DEPOSIT' %}selected{% endif %}>Deposits</option>
                    <option value="WITHDRAWAL" {% if selected_type == 'WITHDRAWAL' %}selected{% endif %}>Withdrawals</option>
                    <option value="PRICE_UPDATE" {% if selected_type == 'PRICE_UPDATE' %}selected{% endif %}>Price Updates</option>
                </select>
            </div>
        </div>

        {% include "partials/events_table.html" %}
    </div>
</div>

<!-- Event Details Modal -->
<dialog id="event-modal" class="modal">
    <div class="modal-box max-w-2xl">
        <h3 class="font-bold text-lg mb-4">Event Details</h3>
        <div id="event-modal-content">
            <!-- Content will be populated by JavaScript -->
        </div>
        <div class="modal-action">
            <form method="dialog">
                <button class="btn">Close</button>
            </form>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<script>
    // Store events data for modal display
    const eventsData = {
        {% for event in events %}
        {{ event.event_id }}: {
            event_id: {{ event.event_id }},
            timestamp: "{{ event.timestamp }}",
            event_type: "{{ event.event_type }}",
            data: {{ event.data | tojson }},
            reason: {{ event.reason | tojson }},
            notes: "{{ event.notes | replace('"', '\\"') | replace('\n', '\\n') }}",
            cash_delta: {{ event.cash_delta }}
        },
        {% endfor %}
    };

    function showEventDetails(eventId) {
        const event = eventsData[eventId];
        if (!event) return;

        let html = `
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <span class="text-sm text-base-content/60">Event ID</span>
                        <div class="font-mono">${event.event_id}</div>
                    </div>
                    <div>
                        <span class="text-sm text-base-content/60">Timestamp</span>
                        <div>${event.timestamp}</div>
                    </div>
                    <div>
                        <span class="text-sm text-base-content/60">Type</span>
                        <div class="badge badge-primary">${event.event_type}</div>
                    </div>
                    <div>
                        <span class="text-sm text-base-content/60">Cash Impact</span>
                        <div class="font-mono ${event.cash_delta > 0 ? 'text-success' : event.cash_delta < 0 ? 'text-error' : ''}">${event.cash_delta !== 0 ? (event.cash_delta > 0 ? '+' : '') + event.cash_delta.toLocaleString() : '-'}</div>
                    </div>
                </div>

                <div class="divider">Event Data</div>
                <pre class="bg-base-200 p-3 rounded-lg text-sm overflow-x-auto">${JSON.stringify(event.data, null, 2)}</pre>

                ${event.reason.explanation ? `
                <div>
                    <span class="text-sm text-base-content/60">User's Reason</span>
                    <div class="mt-1">${event.reason.explanation}</div>
                </div>
                ` : ''}

                ${event.notes ? `
                <div>
                    <span class="text-sm text-base-content/60">Notes</span>
                    <div class="mt-1">${event.notes}</div>
                </div>
                ` : ''}
        `;

        // Add AI Insights section if available
        if (event.reason.ai_insights) {
            const ai = event.reason.ai_insights;
            html += `
                <div class="divider">AI Insights</div>
                <div class="alert alert-info mb-2">
                    <span class="text-xs">Generated by ${event.reason.ai_model || 'AI'} at ${event.reason.ai_generated_at || 'unknown'}</span>
                </div>

                <div class="space-y-3">
                    <div class="bg-base-200 p-3 rounded-lg">
                        <div class="font-semibold text-primary mb-1">Reasoning</div>
                        <div class="text-sm">${ai.reasoning || 'Not available'}</div>
                    </div>

                    <div class="bg-base-200 p-3 rounded-lg">
                        <div class="font-semibold text-secondary mb-1">Future Advice</div>
                        <div class="text-sm">${ai.future_advice || 'Not available'}</div>
                    </div>

                    <div class="bg-base-200 p-3 rounded-lg">
                        <div class="font-semibold text-accent mb-1">Past Reflection</div>
                        <div class="text-sm">${ai.past_reflection || 'Not available'}</div>
                    </div>
                </div>
            `;
        }

        html += '</div>';

        document.getElementById('event-modal-content').innerHTML = html;
        document.getElementById('event-modal').showModal();
    }
</script>
{% endblock %}
