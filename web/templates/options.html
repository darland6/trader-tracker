{% extends "base.html" %}

{% block title %}Options - Portfolio Manager{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Active Options -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <div class="flex justify-between items-center">
                <h2 class="card-title">Active Options</h2>
                <button hx-post="/api/options/auto-expire"
                        hx-swap="none"
                        hx-on::after-request="window.location.reload()"
                        class="btn btn-sm btn-outline">
                    Check Expirations
                </button>
            </div>
            {% if active_options %}
            <div class="overflow-x-auto">
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Action</th>
                            <th>Ticker</th>
                            <th>Type</th>
                            <th>Strike</th>
                            <th>Expiration</th>
                            <th>Contracts</th>
                            <th>Premium</th>
                            <th>Days Left</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for opt in active_options %}
                        <tr>
                            <td class="font-mono text-xs">{{ opt.position_id or opt.event_id }}</td>
                            <td>
                                <span class="badge {{ 'badge-success' if opt.action == 'SELL' else 'badge-warning' }}">
                                    {{ opt.action or 'SELL' }}
                                </span>
                            </td>
                            <td class="font-bold">{{ opt.ticker }}</td>
                            <td>{{ opt.strategy }}</td>
                            <td>${{ opt.strike }}</td>
                            <td>{{ opt.expiration }}</td>
                            <td>{{ '-' if opt.action == 'SELL' else '' }}{{ opt.contracts }}</td>
                            <td class="{{ 'text-success' if opt.action == 'SELL' else 'text-warning' }}">
                                ${{ "{:,.0f}".format(opt.premium) }}
                            </td>
                            <td class="{% if opt.days_to_expiry <= 7 %}text-warning{% elif opt.days_to_expiry < 0 %}text-error{% endif %}">
                                {{ opt.days_to_expiry }}{% if opt.days_to_expiry < 0 %} (EXPIRED){% endif %}
                            </td>
                            <td>
                                <div class="dropdown dropdown-end">
                                    <label tabindex="0" class="btn btn-sm btn-ghost">Close</label>
                                    <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-64">
                                        <li>
                                            <a onclick="openCloseModal('{{ opt.position_id }}', {{ opt.event_id }}, '{{ opt.ticker }}', {{ opt.strike }}, {{ opt.premium }}, '{{ opt.action or 'SELL' }}')">
                                                {{ 'Sell to Close' if opt.action == 'BUY' else 'Buy to Close' }} (enter cost)
                                            </a>
                                        </li>
                                        <li>
                                            <button hx-post="/api/options/close"
                                                    hx-vals='{"position_id": "{{ opt.position_id }}", "event_id": {{ opt.event_id }}, "close_type": "EXPIRE", "close_cost": 0}'
                                                    hx-swap="none"
                                                    hx-on::after-request="window.location.reload()">
                                                Expire Worthless
                                            </button>
                                        </li>
                                        <li>
                                            <button hx-post="/api/options/close"
                                                    hx-vals='{"position_id": "{{ opt.position_id }}", "event_id": {{ opt.event_id }}, "close_type": "ASSIGN", "close_cost": 0}'
                                                    hx-swap="none"
                                                    hx-on::after-request="window.location.reload()">
                                                Assigned
                                            </button>
                                        </li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-base-content/60">No active options</p>
            {% endif %}
        </div>
    </div>

    <!-- Close Option Modal -->
    <dialog id="close-modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Close Option Position</h3>
            <p class="py-2">
                <span id="close-modal-action" class="badge"></span>
                <span id="close-modal-ticker" class="font-bold"></span> @ $<span id="close-modal-strike"></span>
            </p>
            <p class="text-sm text-base-content/60">
                Premium: $<span id="close-modal-premium"></span>
            </p>
            <form hx-post="/api/options/close"
                  hx-swap="none"
                  hx-on::after-request="document.getElementById('close-modal').close(); window.location.reload();"
                  class="py-4">
                <input type="hidden" name="position_id" id="close-modal-position-id">
                <input type="hidden" name="event_id" id="close-modal-event-id">
                <input type="hidden" name="close_type" value="CLOSE">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text" id="close-modal-cost-label">Cost to Close</span>
                    </label>
                    <input type="number" name="close_cost" id="close-modal-cost"
                           class="input input-bordered"
                           placeholder="0.00"
                           min="0"
                           step="0.01"
                           required
                           oninput="updateProfit()">
                </div>
                <div class="mt-2 text-lg">
                    P&L: <span id="close-modal-profit" class="font-bold">$0</span>
                </div>
                <div class="form-control mt-4">
                    <label class="label">
                        <span class="label-text">Reason</span>
                    </label>
                    <input type="text" name="reason"
                           class="input input-bordered"
                           placeholder="Why closing?">
                </div>
                <div class="modal-action">
                    <button type="button" class="btn" onclick="document.getElementById('close-modal').close()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Close Position</button>
                </div>
            </form>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <script>
        let currentPremium = 0;
        let currentAction = 'SELL';

        function openCloseModal(positionId, eventId, ticker, strike, premium, action) {
            currentPremium = premium;
            currentAction = action || 'SELL';

            document.getElementById('close-modal-position-id').value = positionId;
            document.getElementById('close-modal-event-id').value = eventId;
            document.getElementById('close-modal-ticker').textContent = ticker;
            document.getElementById('close-modal-strike').textContent = strike;
            document.getElementById('close-modal-premium').textContent = premium.toLocaleString();
            document.getElementById('close-modal-cost').value = '';

            // Update action badge
            const actionEl = document.getElementById('close-modal-action');
            actionEl.textContent = currentAction;
            actionEl.className = 'badge ' + (currentAction === 'SELL' ? 'badge-success' : 'badge-warning');

            // Update cost label based on action
            const costLabel = document.getElementById('close-modal-cost-label');
            costLabel.textContent = currentAction === 'SELL' ? 'Cost to Buy Back' : 'Premium Received from Sale';

            updateProfit();
            document.getElementById('close-modal').showModal();
        }

        function updateProfit() {
            const cost = parseFloat(document.getElementById('close-modal-cost').value) || 0;
            let profit;

            if (currentAction === 'SELL') {
                // Sold option: profit = premium received - cost to buy back
                profit = currentPremium - cost;
            } else {
                // Bought option: profit = sale price - premium paid
                profit = cost - currentPremium;
            }

            const profitEl = document.getElementById('close-modal-profit');
            profitEl.textContent = '$' + profit.toLocaleString();
            profitEl.className = 'font-bold ' + (profit >= 0 ? 'text-success' : 'text-error');
        }
    </script>

    <!-- Open New Option -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h2 class="card-title">Open New Option</h2>

            <form id="option-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Action (BUY/SELL) -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-bold">Action</span>
                        </label>
                        <select name="action" id="option-action" class="select select-bordered" required onchange="updatePremiumLabel()">
                            <option value="SELL">SELL (receive premium)</option>
                            <option value="BUY">BUY (pay premium)</option>
                        </select>
                    </div>

                    <!-- Ticker -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-bold">Underlying Ticker</span>
                        </label>
                        <input type="text" name="ticker" id="option-ticker"
                               class="input input-bordered"
                               placeholder="BMNR"
                               required
                               oninput="this.value = this.value.toUpperCase()">
                    </div>

                    <!-- Strategy -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-bold">Type</span>
                        </label>
                        <select name="strategy" id="option-strategy" class="select select-bordered" required>
                            <option value="Put">Put</option>
                            <option value="Call">Call</option>
                        </select>
                    </div>

                    <!-- Strike -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-bold">Strike Price</span>
                        </label>
                        <input type="number" name="strike" id="option-strike"
                               class="input input-bordered"
                               placeholder="31.00"
                               required
                               min="0.01"
                               step="0.01">
                    </div>

                    <!-- Expiration -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-bold">Expiration Date</span>
                        </label>
                        <input type="date" name="expiration" id="option-expiration"
                               class="input input-bordered"
                               required>
                    </div>

                    <!-- Contracts -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-bold">Contracts</span>
                        </label>
                        <input type="number" name="contracts" id="option-contracts"
                               class="input input-bordered"
                               value="1"
                               required
                               min="1">
                    </div>

                    <!-- Premium -->
                    <div class="form-control md:col-span-2">
                        <label class="label">
                            <span class="label-text font-bold" id="premium-label">Total Premium Received</span>
                        </label>
                        <input type="number" name="premium" id="option-premium"
                               class="input input-bordered"
                               placeholder="4000"
                               required
                               min="0.01"
                               step="0.01">
                    </div>

                    <!-- Reason -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-bold">Reason</span>
                        </label>
                        <input type="text" name="reason" id="option-reason"
                               class="input input-bordered"
                               placeholder="Income generation">
                    </div>
                </div>

                <div class="form-control mt-4">
                    <button type="submit" class="btn btn-secondary btn-lg">
                        Open Option Position
                    </button>
                </div>
            </form>

            <div id="option-result" class="mt-4"></div>
        </div>
    </div>

    <script>
        function updatePremiumLabel() {
            const action = document.getElementById('option-action').value;
            const label = document.getElementById('premium-label');
            label.textContent = action === 'SELL' ? 'Total Premium Received' : 'Total Premium Paid';
        }

        // Handle form submission
        document.getElementById('option-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const form = e.target;
            const resultDiv = document.getElementById('option-result');

            const payload = {
                action: document.getElementById('option-action').value,
                ticker: document.getElementById('option-ticker').value,
                strategy: document.getElementById('option-strategy').value,
                strike: parseFloat(document.getElementById('option-strike').value),
                expiration: document.getElementById('option-expiration').value,
                contracts: parseInt(document.getElementById('option-contracts').value),
                premium: parseFloat(document.getElementById('option-premium').value),
                reason: document.getElementById('option-reason').value
            };

            try {
                const response = await fetch('/api/options/open', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    resultDiv.innerHTML = `<div class="alert alert-success">
                        <span>${data.message}</span>
                    </div>`;
                    form.reset();
                    updatePremiumLabel();
                    // Reload page after short delay to show updated options
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-error">
                        <span>Error: ${data.detail || data.message || 'Unknown error'}</span>
                    </div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-error">
                    <span>Error: ${error.message}</span>
                </div>`;
            }
        });
    </script>
</div>
{% endblock %}
