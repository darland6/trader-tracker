{% extends "base.html" %}

{% block title %}Options - Portfolio Manager{% endblock %}

{% block content %}
<div class="space-y-6" x-data="optionsData()">
    <!-- Cash Secured Summary -->
    <div class="stats shadow bg-base-100 w-full">
        <div class="stat">
            <div class="stat-title">Cash Available</div>
            <div class="stat-value text-success" x-text="'$' + cash.toLocaleString()">Loading...</div>
            <div class="stat-desc">Current cash balance</div>
        </div>
        <div class="stat">
            <div class="stat-title">Cash to Secure Puts</div>
            <div class="stat-value" :class="cashRequired <= cash ? 'text-info' : 'text-error'" x-text="'$' + cashRequired.toLocaleString()">Loading...</div>
            <div class="stat-desc">Required if all puts assigned</div>
        </div>
        <div class="stat">
            <div class="stat-title">Coverage</div>
            <div class="stat-value" :class="coveragePct >= 100 ? 'text-success' : 'text-warning'" x-text="coveragePct.toFixed(0) + '%'">Loading...</div>
            <div class="stat-desc" x-text="cashRequired <= cash ? 'Fully secured' : 'Margin required'"></div>
        </div>
        <div class="stat">
            <div class="stat-title">Free Cash</div>
            <div class="stat-value" :class="freeCash >= 0 ? 'text-success' : 'text-error'" x-text="(freeCash >= 0 ? '$' : '-$') + Math.abs(freeCash).toLocaleString()">Loading...</div>
            <div class="stat-desc">After securing puts</div>
        </div>
        <div class="stat">
            <div class="stat-title">Options P&L</div>
            <div class="stat-value" :class="optionsPnL >= 0 ? 'text-success' : 'text-error'" x-text="(optionsPnL >= 0 ? '+$' : '-$') + Math.abs(optionsPnL).toLocaleString()">Loading...</div>
            <div class="stat-desc">Unrealized gain/loss</div>
        </div>
    </div>

    <!-- Active Options -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <div class="flex justify-between items-center">
                <h2 class="card-title">Active Options</h2>
                <button hx-post="/api/options/auto-expire"
                        hx-swap="none"
                        hx-on::after-request="window.location.reload()"
                        class="btn btn-sm btn-outline">
                    Check Expirations
                </button>
            </div>
            {% if active_options %}
            <div class="overflow-x-auto">
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Action</th>
                            <th>Ticker</th>
                            <th>Type</th>
                            <th>Strike</th>
                            <th>Expiration</th>
                            <th>Contracts</th>
                            <th>Premium</th>
                            <th>Current Value</th>
                            <th>Unrealized P&L</th>
                            <th>Cash Secured</th>
                            <th>Days Left</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for opt in active_options %}
                        <tr>
                            <td class="font-mono text-xs">{{ opt.position_id or opt.event_id }}</td>
                            <td>
                                <span class="badge {{ 'badge-success' if opt.action == 'SELL' else 'badge-warning' }}">
                                    {{ opt.action or 'SELL' }}
                                </span>
                            </td>
                            <td class="font-bold">{{ opt.ticker }}</td>
                            <td>{{ opt.strategy }}</td>
                            <td>${{ opt.strike }}</td>
                            <td>{{ opt.expiration }}</td>
                            <td>{{ '-' if opt.action == 'SELL' else '' }}{{ opt.contracts }}</td>
                            <td class="{{ 'text-success' if opt.action == 'SELL' else 'text-warning' }}">
                                ${{ "{:,.0f}".format(opt.premium) }}
                            </td>
                            <td class="font-mono">
                                {% if opt.current_value is not none %}
                                ${{ "{:,.0f}".format(opt.current_value) }}
                                {% else %}
                                <span class="text-base-content/40">--</span>
                                {% endif %}
                            </td>
                            <td class="font-mono font-bold {% if opt.unrealized_pnl is not none %}{{ 'text-success' if opt.unrealized_pnl >= 0 else 'text-error' }}{% endif %}">
                                {% if opt.unrealized_pnl is not none %}
                                {{ '+' if opt.unrealized_pnl >= 0 else '' }}${{ "{:,.0f}".format(opt.unrealized_pnl) }}
                                <span class="text-xs">({{ "{:+.0f}".format(opt.unrealized_pnl_pct) }}%)</span>
                                {% else %}
                                <span class="text-base-content/40">--</span>
                                {% endif %}
                            </td>
                            <td class="font-mono {% if opt.action == 'SELL' and opt.strategy == 'Put' %}text-info{% else %}text-base-content/40{% endif %}">
                                {% if opt.action == 'SELL' and opt.strategy == 'Put' %}
                                ${{ "{:,.0f}".format(opt.strike * 100 * opt.contracts) }}
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td class="{% if opt.days_to_expiry <= 7 %}text-warning{% elif opt.days_to_expiry < 0 %}text-error{% endif %}">
                                {{ opt.days_to_expiry }}{% if opt.days_to_expiry < 0 %} (EXPIRED){% endif %}
                            </td>
                            <td>
                                <div class="dropdown dropdown-end">
                                    <label tabindex="0" class="btn btn-sm btn-ghost">Close</label>
                                    <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-64">
                                        <li>
                                            <a onclick="openCloseModal('{{ opt.position_id }}', {{ opt.event_id }}, '{{ opt.ticker }}', {{ opt.strike }}, {{ opt.premium }}, '{{ opt.action or 'SELL' }}')">
                                                {{ 'Sell to Close' if opt.action == 'BUY' else 'Buy to Close' }} (enter cost)
                                            </a>
                                        </li>
                                        <li>
                                            <button hx-post="/api/options/close"
                                                    hx-vals='{"position_id": "{{ opt.position_id }}", "event_id": {{ opt.event_id }}, "close_type": "EXPIRE", "close_cost": 0}'
                                                    hx-swap="none"
                                                    hx-on::after-request="window.location.reload()">
                                                Expire Worthless
                                            </button>
                                        </li>
                                        <li>
                                            <button hx-post="/api/options/close"
                                                    hx-vals='{"position_id": "{{ opt.position_id }}", "event_id": {{ opt.event_id }}, "close_type": "ASSIGN", "close_cost": 0}'
                                                    hx-swap="none"
                                                    hx-on::after-request="window.location.reload()">
                                                Assigned
                                            </button>
                                        </li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-base-content/60">No active options</p>
            {% endif %}
        </div>
    </div>

    <!-- Close Option Modal -->
    <dialog id="close-modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Close Option Position</h3>
            <p class="py-2">
                <span id="close-modal-action" class="badge"></span>
                <span id="close-modal-ticker" class="font-bold"></span> @ $<span id="close-modal-strike"></span>
            </p>
            <p class="text-sm text-base-content/60">
                Premium: $<span id="close-modal-premium"></span>
            </p>
            <form hx-post="/api/options/close"
                  hx-swap="none"
                  hx-on::after-request="document.getElementById('close-modal').close(); window.location.reload();"
                  class="py-4">
                <input type="hidden" name="position_id" id="close-modal-position-id">
                <input type="hidden" name="event_id" id="close-modal-event-id">
                <input type="hidden" name="close_type" value="CLOSE">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text" id="close-modal-cost-label">Cost to Close</span>
                    </label>
                    <input type="number" name="close_cost" id="close-modal-cost"
                           class="input input-bordered"
                           placeholder="0.00"
                           min="0"
                           step="0.01"
                           required
                           oninput="updateProfit()">
                </div>
                <div class="mt-2 text-lg">
                    P&L: <span id="close-modal-profit" class="font-bold">$0</span>
                </div>
                <div class="form-control mt-4">
                    <label class="label">
                        <span class="label-text">Reason</span>
                    </label>
                    <input type="text" name="reason"
                           class="input input-bordered"
                           placeholder="Why closing?">
                </div>
                <div class="modal-action">
                    <button type="button" class="btn" onclick="document.getElementById('close-modal').close()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Close Position</button>
                </div>
            </form>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <script>
        let currentPremium = 0;
        let currentAction = 'SELL';

        function openCloseModal(positionId, eventId, ticker, strike, premium, action) {
            currentPremium = premium;
            currentAction = action || 'SELL';

            document.getElementById('close-modal-position-id').value = positionId;
            document.getElementById('close-modal-event-id').value = eventId;
            document.getElementById('close-modal-ticker').textContent = ticker;
            document.getElementById('close-modal-strike').textContent = strike;
            document.getElementById('close-modal-premium').textContent = premium.toLocaleString();
            document.getElementById('close-modal-cost').value = '';

            // Update action badge
            const actionEl = document.getElementById('close-modal-action');
            actionEl.textContent = currentAction;
            actionEl.className = 'badge ' + (currentAction === 'SELL' ? 'badge-success' : 'badge-warning');

            // Update cost label based on action
            const costLabel = document.getElementById('close-modal-cost-label');
            costLabel.textContent = currentAction === 'SELL' ? 'Cost to Buy Back' : 'Premium Received from Sale';

            updateProfit();
            document.getElementById('close-modal').showModal();
        }

        function updateProfit() {
            const cost = parseFloat(document.getElementById('close-modal-cost').value) || 0;
            let profit;

            if (currentAction === 'SELL') {
                // Sold option: profit = premium received - cost to buy back
                profit = currentPremium - cost;
            } else {
                // Bought option: profit = sale price - premium paid
                profit = cost - currentPremium;
            }

            const profitEl = document.getElementById('close-modal-profit');
            profitEl.textContent = '$' + profit.toLocaleString();
            profitEl.className = 'font-bold ' + (profit >= 0 ? 'text-success' : 'text-error');
        }
    </script>

    <!-- Open New Option -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h2 class="card-title">Open New Option</h2>

            <form id="option-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Action (BUY/SELL) -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-bold">Action</span>
                        </label>
                        <select name="action" id="option-action" class="select select-bordered" required onchange="updatePremiumLabel()">
                            <option value="SELL">SELL (receive premium)</option>
                            <option value="BUY">BUY (pay premium)</option>
                        </select>
                    </div>

                    <!-- Ticker -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-bold">Underlying Ticker</span>
                        </label>
                        <input type="text" name="ticker" id="option-ticker"
                               class="input input-bordered"
                               placeholder="BMNR"
                               required
                               oninput="this.value = this.value.toUpperCase()">
                    </div>

                    <!-- Strategy -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-bold">Type</span>
                        </label>
                        <select name="strategy" id="option-strategy" class="select select-bordered" required>
                            <option value="Put">Put</option>
                            <option value="Call">Call</option>
                        </select>
                    </div>

                    <!-- Strike -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-bold">Strike Price</span>
                        </label>
                        <input type="number" name="strike" id="option-strike"
                               class="input input-bordered"
                               placeholder="31.00"
                               required
                               min="0.01"
                               step="0.01">
                    </div>

                    <!-- Expiration -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-bold">Expiration Date</span>
                        </label>
                        <input type="date" name="expiration" id="option-expiration"
                               class="input input-bordered"
                               required>
                    </div>

                    <!-- Contracts -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-bold">Contracts</span>
                        </label>
                        <input type="number" name="contracts" id="option-contracts"
                               class="input input-bordered"
                               value="1"
                               required
                               min="1"
                               oninput="calculateTotalPremium()">
                    </div>

                    <!-- Premium per Share -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-bold" id="premium-label">Premium per Share</span>
                        </label>
                        <input type="number" id="option-premium-per-share"
                               class="input input-bordered"
                               placeholder="2.50"
                               required
                               min="0.01"
                               step="0.01"
                               oninput="calculateTotalPremium()">
                    </div>

                    <!-- Total Premium (calculated) -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-bold">Total Premium</span>
                        </label>
                        <div class="input input-bordered bg-base-200 flex items-center" id="total-premium-display">
                            $<span id="total-premium-value">0.00</span>
                        </div>
                        <input type="hidden" name="premium" id="option-premium">
                    </div>

                    <!-- Reason -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-bold">Reason</span>
                        </label>
                        <input type="text" name="reason" id="option-reason"
                               class="input input-bordered"
                               placeholder="Income generation">
                    </div>
                </div>

                <div class="form-control mt-4">
                    <button type="submit" id="submit-btn" class="btn btn-secondary btn-lg">
                        Open Option Position
                    </button>
                </div>

                <div id="option-result" class="mt-4"></div>
            </form>
        </div>
    </div>

    <script>
        // Calculate total premium from per-share price
        function calculateTotalPremium() {
            const perShare = parseFloat(document.getElementById('option-premium-per-share').value) || 0;
            const contracts = parseInt(document.getElementById('option-contracts').value) || 0;
            const total = perShare * 100 * contracts;

            document.getElementById('total-premium-value').textContent = total.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('option-premium').value = total;
        }

        // Prevent duplicate submissions
        let isSubmitting = false;

        // Handle form submission
        document.getElementById('option-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            // Prevent duplicate submissions
            if (isSubmitting) {
                console.log('Already submitting, ignoring click');
                return;
            }

            const form = e.target;
            const resultDiv = document.getElementById('option-result');
            const submitBtn = document.getElementById('submit-btn');

            // Calculate total premium before submission
            calculateTotalPremium();
            const totalPremium = parseFloat(document.getElementById('option-premium').value);

            if (!totalPremium || totalPremium <= 0) {
                resultDiv.innerHTML = `<div class="alert alert-error">
                    <span>Please enter a valid premium per share</span>
                </div>`;
                return;
            }

            // Disable button and show loading
            isSubmitting = true;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="loading loading-spinner"></span> Saving...';
            resultDiv.innerHTML = '';

            const payload = {
                action: document.getElementById('option-action').value,
                ticker: document.getElementById('option-ticker').value,
                strategy: document.getElementById('option-strategy').value,
                strike: parseFloat(document.getElementById('option-strike').value),
                expiration: document.getElementById('option-expiration').value,
                contracts: parseInt(document.getElementById('option-contracts').value),
                premium: totalPremium,
                reason: document.getElementById('option-reason').value
            };

            console.log('Submitting option:', payload);

            try {
                const response = await fetch('/api/options/open', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                console.log('Response:', data);

                if (response.ok && data.success) {
                    resultDiv.innerHTML = `<div class="alert alert-success">
                        <span>âœ“ ${data.message}</span>
                    </div>`;
                    // Reload page immediately to show new option
                    setTimeout(() => { window.location.href = '/options'; }, 1000);
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-error">
                        <span>Error: ${data.detail || data.message || 'Unknown error'}</span>
                    </div>`;
                    // Re-enable button on error
                    isSubmitting = false;
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = 'Open Option Position';
                }
            } catch (error) {
                console.error('Submit error:', error);
                resultDiv.innerHTML = `<div class="alert alert-error">
                    <span>Error: ${error.message}</span>
                </div>`;
                // Re-enable button on error
                isSubmitting = false;
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Open Option Position';
            }
        });

        // Update premium label based on action type
        function updatePremiumLabel() {
            const action = document.getElementById('option-action').value;
            const label = document.getElementById('premium-label');
            label.textContent = action === 'SELL' ? 'Premium Received per Share' : 'Premium Paid per Share';
        }
    </script>

    <!-- Alpine.js data for cash calculations -->
    <script>
        function optionsData() {
            return {
                cash: 0,
                cashRequired: 0,
                coveragePct: 0,
                freeCash: 0,
                optionsPnL: 0,

                async init() {
                    try {
                        const response = await fetch('/api/state');
                        const state = await response.json();
                        this.cash = Math.round(state.cash || 0);

                        // Calculate cash required for sold puts
                        const options = state.active_options || [];
                        this.cashRequired = options.reduce((sum, opt) => {
                            if ((opt.action === 'SELL' || !opt.action) && opt.strategy === 'Put') {
                                return sum + (opt.strike * 100 * (opt.contracts || 1));
                            }
                            return sum;
                        }, 0);

                        this.cashRequired = Math.round(this.cashRequired);
                        this.coveragePct = this.cashRequired > 0 ? (this.cash / this.cashRequired) * 100 : 100;
                        this.freeCash = this.cash - this.cashRequired;

                        // Calculate total options P&L
                        this.optionsPnL = options.reduce((sum, opt) => {
                            if (opt.unrealized_pnl !== null && opt.unrealized_pnl !== undefined) {
                                return sum + opt.unrealized_pnl;
                            }
                            return sum;
                        }, 0);
                        this.optionsPnL = Math.round(this.optionsPnL);
                    } catch (error) {
                        console.error('Failed to load cash data:', error);
                    }
                }
            };
        }
    </script>
</div>
{% endblock %}
