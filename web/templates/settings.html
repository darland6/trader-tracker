{% extends "base.html" %}

{% block title %}Settings - Portfolio Manager{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Backup Section -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h2 class="card-title">Database Backup</h2>
            <p class="text-base-content/60 mb-4">Create and manage backups of your portfolio event log.</p>

            <div class="flex gap-4 flex-wrap">
                <button hx-post="/api/backup/create"
                        hx-target="#backup-result"
                        hx-swap="innerHTML"
                        class="btn btn-primary">
                    Create Backup
                </button>

                <a href="/api/backup/download-current" class="btn btn-outline">
                    Download Current DB
                </a>
            </div>

            <div id="backup-result" class="mt-4"></div>
        </div>
    </div>

    <!-- Existing Backups -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <div class="flex justify-between items-center">
                <h2 class="card-title">Saved Backups</h2>
                <button onclick="loadBackups()" class="btn btn-sm btn-ghost">Refresh</button>
            </div>

            <div id="backups-list" class="mt-4">
                <div class="text-center py-4 text-base-content/60">Loading backups...</div>
            </div>
        </div>
    </div>

    <!-- Upload Restore -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h2 class="card-title">Upload & Restore</h2>
            <p class="text-base-content/60 mb-4">Upload a backup file to restore your portfolio.</p>

            <div class="alert alert-warning mb-4">
                <span>Warning: Restoring will replace your current data. A backup will be created automatically before restore.</span>
            </div>

            <form id="upload-form" class="space-y-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Select backup file (.csv)</span>
                    </label>
                    <input type="file" name="file" accept=".csv"
                           class="file-input file-input-bordered w-full"
                           id="backup-file">
                </div>

                <button type="submit" class="btn btn-warning">
                    Upload & Restore
                </button>
            </form>

            <div id="upload-result" class="mt-4"></div>
        </div>
    </div>

    <!-- Learning Files Section -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <div class="flex justify-between items-center mb-4">
                <h2 class="card-title">Learning & Memory Files</h2>
                <button onclick="loadLearningFiles()" class="btn btn-sm btn-ghost">Refresh</button>
            </div>
            <p class="text-base-content/60 mb-4">Files used by the AI agent to remember conversations, learn patterns, and track usage.</p>

            <div id="learning-files-list">
                <div class="text-center py-4 text-base-content/60">Loading...</div>
            </div>
        </div>
    </div>

    <!-- LLM Settings -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h2 class="card-title">AI Settings</h2>

            <!-- Current Config Display -->
            <div class="alert {% if llm_config.enabled %}alert-success{% else %}alert-warning{% endif %} mb-4">
                <div>
                    <strong>{{ llm_config.provider|upper }}</strong> |
                    Model: <code>{% if llm_config.provider == 'local' %}{{ llm_config.local_model }}{% else %}{{ llm_config.claude_model }}{% endif %}</code> |
                    {% if llm_config.enabled %}Enabled{% else %}Disabled{% endif %}
                    {% if llm_config.provider == 'claude' %}
                    | API Key: <span id="api-key-status">{% if llm_config.has_api_key %}Set{% else %}Not Set{% endif %}</span>
                    {% endif %}
                </div>
            </div>

            <!-- API Key Input (for Claude) -->
            <div class="form-control mb-4" id="api-key-section">
                <label class="label">
                    <span class="label-text font-semibold">Anthropic API Key</span>
                    <span class="label-text-alt text-info">Required for Claude provider</span>
                </label>
                <div class="join w-full">
                    <input type="password" id="api-key-input" placeholder="sk-ant-..."
                           class="input input-bordered join-item flex-1 font-mono text-sm">
                    <button onclick="saveApiKey()" class="btn btn-primary join-item">Save Key</button>
                </div>
                <label class="label">
                    <span class="label-text-alt text-base-content/60">Get your key from <a href="https://console.anthropic.com/" target="_blank" class="link">console.anthropic.com</a></span>
                </label>
            </div>

            <!-- JSON Editor - populated by Jinja2 -->
            <textarea id="llm-json" class="textarea textarea-bordered w-full font-mono text-sm" rows="10" spellcheck="false">{
  "provider": "{{ llm_config.provider }}",
  "enabled": {{ llm_config.enabled|lower }},
  "claude_model": "{{ llm_config.claude_model }}",
  "local_url": "{{ llm_config.local_url }}",
  "local_model": "{{ llm_config.local_model }}",
  "timeout": {{ llm_config.timeout }},
  "max_history_events": {{ llm_config.max_history_events }}
}</textarea>

            <div class="mt-4 flex gap-2">
                <button onclick="saveLLM()" class="btn btn-primary">Save</button>
                <button onclick="testLLM()" class="btn btn-outline">Test Connection</button>
                <button onclick="location.reload()" class="btn btn-ghost">Reload</button>
            </div>

            <div id="llm-msg" class="mt-4"></div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadBackups();
    loadLearningFiles();
});

async function loadBackups() {
    try {
        const response = await fetch('/api/backup/list');
        const data = await response.json();
        const container = document.getElementById('backups-list');

        if (data.backups.length === 0) {
            container.innerHTML = '<p class="text-base-content/60">No backups found.</p>';
            return;
        }

        let html = '<div class="overflow-x-auto"><table class="table"><thead><tr><th>Filename</th><th>Size</th><th>Created</th><th>Actions</th></tr></thead><tbody>';
        data.backups.forEach(backup => {
            const date = new Date(backup.created).toLocaleString();
            html += `<tr>
                <td class="font-mono text-sm">${backup.filename}</td>
                <td>${backup.size_kb} KB</td>
                <td>${date}</td>
                <td class="flex gap-2">
                    <a href="/api/backup/download/${backup.filename}" class="btn btn-xs btn-ghost">Download</a>
                    <button onclick="restoreBackup('${backup.filename}')" class="btn btn-xs btn-warning">Restore</button>
                    <button onclick="deleteBackup('${backup.filename}')" class="btn btn-xs btn-error">Delete</button>
                </td>
            </tr>`;
        });
        html += '</tbody></table></div>';
        container.innerHTML = html;
    } catch (error) {
        document.getElementById('backups-list').innerHTML = '<p class="text-error">Failed to load backups</p>';
    }
}

async function restoreBackup(filename) {
    if (!confirm('Restore from ' + filename + '? Current data will be backed up first.')) return;
    try {
        const response = await fetch('/api/backup/restore/' + filename, { method: 'POST' });
        const data = await response.json();
        if (data.success) {
            alert('Restored successfully!');
            location.reload();
        } else {
            alert('Restore failed: ' + (data.detail || 'Unknown error'));
        }
    } catch (error) {
        alert('Restore failed: ' + error.message);
    }
}

async function deleteBackup(filename) {
    if (!confirm('Delete ' + filename + '?')) return;
    try {
        await fetch('/api/backup/' + filename, { method: 'DELETE' });
        loadBackups();
    } catch (error) {
        alert('Delete failed: ' + error.message);
    }
}

async function loadLearningFiles() {
    const container = document.getElementById('learning-files-list');
    try {
        const response = await fetch('/api/config/learning-files');
        const data = await response.json();

        if (data.files.length === 0) {
            container.innerHTML = '<p class="text-base-content/60">No learning files found.</p>';
            return;
        }

        // Group by category
        const byCategory = {};
        data.files.forEach(f => {
            if (!byCategory[f.category]) byCategory[f.category] = [];
            byCategory[f.category].push(f);
        });

        let html = '';
        for (const [category, files] of Object.entries(byCategory)) {
            html += `<div class="mb-4">
                <h3 class="font-semibold text-sm text-base-content/70 mb-2">${category}</h3>
                <div class="overflow-x-auto">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>File</th>
                                <th>Description</th>
                                <th>Size</th>
                                <th>Entries</th>
                                <th>Modified</th>
                            </tr>
                        </thead>
                        <tbody>`;

            files.forEach(f => {
                const modified = f.modified ? new Date(f.modified).toLocaleString() : '-';
                const statusBadge = f.exists
                    ? `<span class="badge badge-success badge-xs">exists</span>`
                    : `<span class="badge badge-ghost badge-xs">missing</span>`;
                html += `<tr class="${!f.exists ? 'opacity-50' : ''}">
                    <td class="font-mono text-xs">${f.name} ${statusBadge}</td>
                    <td class="text-xs">${f.description}</td>
                    <td>${f.exists ? f.size_kb + ' KB' : '-'}</td>
                    <td>${f.exists ? f.entries : '-'}</td>
                    <td class="text-xs">${modified}</td>
                </tr>`;
            });

            html += `</tbody></table></div></div>`;
        }

        html += `<p class="text-xs text-base-content/50 mt-2">Data directory: <code>${data.data_dir}</code></p>`;
        container.innerHTML = html;
    } catch (error) {
        container.innerHTML = '<p class="text-error">Failed to load learning files: ' + error.message + '</p>';
    }
}

document.getElementById('upload-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const fileInput = document.getElementById('backup-file');
    if (!fileInput.files.length) { alert('Select a file'); return; }
    if (!confirm('Restore from uploaded file?')) return;

    const formData = new FormData();
    formData.append('file', fileInput.files[0]);

    try {
        const response = await fetch('/api/backup/upload', { method: 'POST', body: formData });
        const data = await response.json();
        if (data.success) {
            document.getElementById('upload-result').innerHTML = '<div class="alert alert-success">Restored!</div>';
            setTimeout(() => location.reload(), 1000);
        } else {
            document.getElementById('upload-result').innerHTML = '<div class="alert alert-error">' + (data.detail || 'Failed') + '</div>';
        }
    } catch (error) {
        document.getElementById('upload-result').innerHTML = '<div class="alert alert-error">' + error.message + '</div>';
    }
});

async function saveLLM() {
    const ta = document.getElementById('llm-json');
    const msg = document.getElementById('llm-msg');
    const content = ta.value;

    try {
        JSON.parse(content);
    } catch (e) {
        msg.innerHTML = '<div class="alert alert-error">Invalid JSON: ' + e.message + '</div>';
        return;
    }

    try {
        const r = await fetch('/api/config/llm/raw', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({content: content})
        });
        if (r.ok) {
            msg.innerHTML = '<div class="alert alert-success">Saved! Reloading...</div>';
            setTimeout(() => location.reload(), 500);
        } else {
            const d = await r.json();
            msg.innerHTML = '<div class="alert alert-error">Error: ' + (d.detail || 'Unknown') + '</div>';
        }
    } catch (e) {
        msg.innerHTML = '<div class="alert alert-error">Error: ' + e.message + '</div>';
    }
}

async function testLLM() {
    const msg = document.getElementById('llm-msg');
    msg.innerHTML = '<div class="alert"><span class="loading loading-spinner loading-sm"></span> Testing...</div>';

    try {
        const r = await fetch('/api/config/llm/test', {method: 'POST'});
        const d = await r.json();
        if (d.success) {
            msg.innerHTML = '<div class="alert alert-success">Connected! Provider: ' + d.provider + ', Model: ' + d.model + '</div>';
        } else {
            msg.innerHTML = '<div class="alert alert-error">Failed: ' + d.error + '</div>';
        }
    } catch (e) {
        msg.innerHTML = '<div class="alert alert-error">Error: ' + e.message + '</div>';
    }
}

async function saveApiKey() {
    const input = document.getElementById('api-key-input');
    const msg = document.getElementById('llm-msg');
    const apiKey = input.value.trim();

    if (!apiKey) {
        msg.innerHTML = '<div class="alert alert-warning">Please enter an API key</div>';
        return;
    }

    if (!apiKey.startsWith('sk-ant-')) {
        msg.innerHTML = '<div class="alert alert-warning">API key should start with sk-ant-</div>';
        return;
    }

    msg.innerHTML = '<div class="alert"><span class="loading loading-spinner loading-sm"></span> Saving API key...</div>';

    try {
        const r = await fetch('/api/config/llm/api-key', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({api_key: apiKey})
        });
        const d = await r.json();
        if (d.success) {
            msg.innerHTML = '<div class="alert alert-success">API key saved! Testing connection...</div>';
            input.value = '';
            // Update status display
            const statusEl = document.getElementById('api-key-status');
            if (statusEl) statusEl.textContent = 'Set';
            // Auto-test the connection
            setTimeout(testLLM, 500);
        } else {
            msg.innerHTML = '<div class="alert alert-error">Failed: ' + (d.detail || 'Unknown error') + '</div>';
        }
    } catch (e) {
        msg.innerHTML = '<div class="alert alert-error">Error: ' + e.message + '</div>';
    }
}
</script>
{% endblock %}
